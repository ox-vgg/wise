import{m as p,n as h,o as d,R as k,p as v,e as r,b as l,i as m,q as y,L as u,l as w,r as j,T,Q as b}from"./index-ab6fc9a5.js";import{E as $,t as f}from"./vidstack-D-FF4ZB9-c73425ca.js";import{resolveVimeoVideoId as P,getVimeoVideoInfo as S}from"./vidstack-BTBUzdbF-c6a540f3.js";import"../config.js";const V=["bufferend","bufferstart","durationchange","ended","enterpictureinpicture","error","fullscreenchange","leavepictureinpicture","loaded","playProgress","loadProgress","pause","play","playbackratechange","qualitychange","seeked","seeking","timeupdate","volumechange","waiting"];class J extends ${constructor(t,e){super(t),this.b=e,this.$$PROVIDER_TYPE="VIMEO",this.scope=p(),this.ha=0,this.ca=new h(0,0),this.Ba=new h(0,0),this.J=null,this.S=null,this.ve=null,this.ia=d(""),this.uc=d(!1),this.we=null,this.L=null,this.Zi=null,this.ga=new k(this.lc.bind(this)),this.jd=null,this.cookies=!1,this.title=!0,this.byline=!0,this.portrait=!0,this.color="00ADEF",this.kd=!1}get c(){return this.b.delegate.c}get type(){return"vimeo"}get currentSrc(){return this.L}get videoId(){return this.ia()}get hash(){return this.we}get isPro(){return this.uc()}preconnect(){v(this.Ob())}setup(){super.setup(),r(this.xe.bind(this)),r(this._i.bind(this)),r(this.$i.bind(this)),this.c("provider-setup",this)}destroy(){this.A(),this.u("destroy")}async play(){const{paused:t}=this.b.$state;return this.J||(this.J=f(()=>{if(this.J=null,t())return"Timed out."}),this.u("play")),this.J.promise}async pause(){const{paused:t}=this.b.$state;return this.S||(this.S=f(()=>{if(this.S=null,!t())return"Timed out."}),this.u("pause")),this.S.promise}setMuted(t){this.u("setMuted",t)}setCurrentTime(t){this.u("seekTo",t),this.c("seeking",t)}setVolume(t){this.u("setVolume",t),this.u("setMuted",l(this.b.$state.muted))}setPlaybackRate(t){this.u("setPlaybackRate",t)}async loadSource(t){if(!m(t.src)){this.L=null,this.we=null,this.ia.set("");return}const{videoId:e,hash:s}=P(t.src);this.ia.set(e??""),this.we=s??null,this.L=t}xe(){this.A();const t=this.ia();if(!t){this.tc.set("");return}this.tc.set(`${this.Ob()}/video/${t}`),this.c("load-start")}_i(){const t=this.ia();if(!t)return;const e=y(),s=new AbortController;return this.ve=e,S(t,s).then(i=>{e.resolve(i)}).catch(i=>{e.reject()}),()=>{e.reject(),s.abort()}}$i(){const t=this.uc(),{$state:e,qualities:s}=this.b;if(e.canSetPlaybackRate.set(t),s[u.Pd](!t),t)return w(s,"change",()=>{var a;if(s.auto)return;const i=(a=s.selected)==null?void 0:a.id;i&&this.u("setQuality",i)})}Ob(){return"https://player.vimeo.com"}ng(){const{keyDisabled:t}=this.b.$props,{playsInline:e,nativeControls:s}=this.b.$state,i=s();return{title:this.title,byline:this.byline,color:this.color,portrait:this.portrait,controls:i,h:this.hash,keyboard:i&&!t(),transparent:!0,playsinline:e(),dnt:!this.cookies}}lc(){this.u("getCurrentTime")}nc(t,e){if(this.kd&&t===0)return;const{realCurrentTime:s,realDuration:i,paused:a,bufferedEnd:n}=this.b.$state;if(s()===t)return;const c=s(),o={currentTime:t,played:this.vc(t)};this.c("time-update",o,e),Math.abs(c-t)>1.5&&(this.c("seeking",t,e),!a()&&n()<t&&this.c("waiting",void 0,e)),i()-t<.01&&(this.c("end",void 0,e),this.kd=!0,setTimeout(()=>{this.kd=!1},500))}vc(t){return this.ha>=t?this.ca:this.ca=new h(0,this.ha=t)}pb(t,e){this.c("seeked",t,e)}ub(t){var s;const e=this.ia();(s=this.ve)==null||s.promise.then(i=>{if(!i)return;const{title:a,poster:n,duration:c,pro:o}=i;this.uc.set(o),this.c("title-change",a,t),this.c("poster-change",n,t),this.c("duration-change",c,t),this.ld(c,t)}).catch(()=>{e===this.ia()&&(this.u("getVideoTitle"),this.u("getDuration"))})}ld(t,e){const{nativeControls:s}=this.b.$state,i=s();this.Ba=new h(0,t);const a={buffered:new h(0,0),seekable:this.Ba,duration:t};this.b.delegate.Ha(a,e),i||this.u("_hideOverlay"),this.u("getQualities"),this.u("getChapters")}aj(t,e,s){switch(t){case"getVideoTitle":const i=e;this.c("title-change",i,s);break;case"getDuration":const a=e;this.b.$state.canPlay()?this.c("duration-change",a,s):this.ld(a,s);break;case"getCurrentTime":this.nc(e,s);break;case"getBuffered":j(e)&&e.length&&this.og(e[e.length-1][1],s);break;case"setMuted":this.Oa(l(this.b.$state.volume),e,s);break;case"getChapters":this.bj(e);break;case"getQualities":this.md(e,s);break}}cj(){for(const t of V)this.u("addEventListener",t)}jb(t){var e;this.ga.aa(),this.c("pause",void 0,t),(e=this.S)==null||e.resolve(),this.S=null}hc(t){var e;this.ga.Ya(),this.c("play",void 0,t),(e=this.J)==null||e.resolve(),this.J=null}dj(t){const{paused:e}=this.b.$state;!e()&&!this.kd&&this.c("playing",void 0,t)}og(t,e){const s={buffered:new h(0,t),seekable:this.Ba};this.c("progress",s,e)}ej(t){this.c("waiting",void 0,t)}fj(t){const{paused:e}=this.b.$state;e()||this.c("playing",void 0,t)}fe(t){const{paused:e}=this.b.$state;e()&&this.c("play",void 0,t),this.c("waiting",void 0,t)}Oa(t,e,s){const i={volume:t,muted:e};this.c("volume-change",i,s)}bj(t){if(this.pg(),!t.length)return;const e=new T({kind:"chapters",default:!0}),{realDuration:s}=this.b.$state;for(let i=0;i<t.length;i++){const a=t[i],n=t[i+1];e.addCue(new window.VTTCue(a.startTime,(n==null?void 0:n.startTime)??s(),a.title))}this.jd=e,this.b.textTracks.add(e)}pg(){this.jd&&(this.b.textTracks.remove(this.jd),this.jd=null)}md(t,e){this.b.qualities[b.Ja]=t.some(s=>s.id==="auto")?()=>this.u("setQuality","auto"):void 0;for(const s of t){if(s.id==="auto")continue;const i=+s.id.slice(0,-1);isNaN(i)||this.b.qualities[u.ea]({id:s.id,width:i*(16/9),height:i,codec:"avc1,h.264",bitrate:-1},e)}this._a(t.find(s=>s.active),e)}_a({id:t}={},e){if(!t)return;const s=t==="auto",i=this.b.qualities.getById(t);s?(this.b.qualities[b.Xa](s,e),this.b.qualities[u.fa](void 0,!0,e)):this.b.qualities[u.fa](i??void 0,!0,e)}gj(t,e,s){switch(t){case"ready":this.cj();break;case"loaded":this.ub(s);break;case"play":this.hc(s);break;case"playProgress":this.dj(s);break;case"pause":this.jb(s);break;case"loadProgress":this.og(e.seconds,s);break;case"waiting":this.fe(s);break;case"bufferstart":this.ej(s);break;case"bufferend":this.fj(s);break;case"volumechange":this.Oa(e.volume,l(this.b.$state.muted),s);break;case"durationchange":this.Ba=new h(0,e.duration),this.c("duration-change",e.duration,s);break;case"playbackratechange":this.c("rate-change",e.playbackRate,s);break;case"qualitychange":this._a(e,s);break;case"fullscreenchange":this.c("fullscreen-change",e.fullscreen,s);break;case"enterpictureinpicture":this.c("picture-in-picture-change",!0,s);break;case"leavepictureinpicture":this.c("picture-in-picture-change",!1,s);break;case"ended":this.c("end",void 0,s);break;case"error":this.R(e,s);break;case"seek":case"seeked":this.pb(e.seconds,s);break}}R(t,e){var s;if(t.method==="setPlaybackRate"&&this.uc.set(!1),t.method==="play"){(s=this.J)==null||s.reject(t.message);return}}ue(t,e){t.event?this.gj(t.event,t.data,e):t.method&&this.aj(t.method,t.value,e)}hd(){}u(t,e){return this.te({method:t,value:e})}A(){this.ga.aa(),this.ha=0,this.ca=new h(0,0),this.Ba=new h(0,0),this.J=null,this.S=null,this.ve=null,this.Zi=null,this.uc.set(!1),this.pg()}}export{J as VimeoProvider};
